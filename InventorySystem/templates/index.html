<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; }
        .sidebar { width: 250px; min-height: 100vh; background-color: #343a40; color: white; position: fixed; }
        .sidebar a { color: #c2c7d0; text-decoration: none; padding: 12px 20px; display: block; border-bottom: 1px solid #4b545c; }
        .sidebar a:hover, .sidebar a.active { background-color: #007bff; color: white; }
        .content { margin-left: 250px; padding-bottom: 50px; }
        .top-navbar { background-color: #28a745; padding: 15px; color: white; }
        .stat-card { color: white; border-radius: 5px; overflow: hidden; height: 120px; position: relative; }
        .bg-blue { background-color: #17a2b8; }
        .bg-green { background-color: #28a745; }
        .bg-orange { background-color: #ffc107; color: #1f2d3d !important; }
        .bg-red { background-color: #dc3545; }
        .stat-icon { position: absolute; top: 20px; right: 20px; font-size: 3.5rem; opacity: 0.3; }
        .inner { padding: 20px; }
        .small-box-footer { background: rgba(0,0,0,0.1); padding: 5px; text-align: center; display: block; color: inherit; text-decoration: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="p-3 text-center border-bottom border-secondary">
        <h4 class="mb-0">üì¶ Inventory</h4>
        <small>Admin System</small>
    </div>
    <div class="p-3 d-flex align-items-center border-bottom border-secondary">
        <div class="bg-success rounded-circle me-2" style="width: 10px; height: 10px;"></div>
        <span>{{ current_user.username }} ({{ current_user.role }})</span>
    </div>
    <nav class="mt-2">
        <a href="{{ url_for('index') }}" class="active"><i class="fas fa-tachometer-alt me-2"></i> Dashboard</a>
        <a href="{{ url_for('index') }}"><i class="fas fa-box me-2"></i> Products</a>
        <a href="{{ url_for('customers') }}"><i class="fas fa-users me-2"></i> Customers</a>
        <a href="{{ url_for('suppliers') }}"><i class="fas fa-truck me-2"></i> Suppliers</a>
        <a href="{{ url_for('history') }}" class="text-secondary text-decoration-none p-2"><i class="fas fa-history me-2"></i> History Log</a>
        <a href="{{ url_for('logout') }}" class="text-danger mt-3"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </nav>
</div>

<div class="content">
    <div class="top-navbar d-flex justify-content-between align-items-center shadow-sm">
        <div class="fs-4"><i class="fas fa-bars"></i> Stock Overview</div>
        
        {% if current_user.role == 'admin' %}
        <a href="{{ url_for('add_product') }}" class="btn btn-light text-success fw-bold shadow-sm">
            <i class="fas fa-plus"></i> Add Product
        </a>
        {% endif %}
    </div>

    <div class="container-fluid mt-4">
        <div class="row g-3 mb-4">
            <div class="col-lg-3 col-6">
                <div class="stat-card bg-blue shadow-sm">
                    <div class="inner"><h3>{{ total_products }}</h3><p>Total Products</p></div>
                    <i class="fas fa-box stat-icon"></i>
                    <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="stat-card bg-green shadow-sm">
                    <div class="inner"><h3>{{ total_quantity }}</h3><p>Total Units</p></div>
                    <i class="fas fa-cubes stat-icon"></i>
                    <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="stat-card bg-orange shadow-sm">
                    <div class="inner"><h3>{{ low_stock }}</h3><p>Low Stock Alert</p></div>
                    <i class="fas fa-exclamation-triangle stat-icon"></i>
                    <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="stat-card bg-red shadow-sm">
                    <div class="inner"><h3>{{ out_of_stock }}</h3><p>Out of Stock</p></div>
                    <i class="fas fa-times-circle stat-icon"></i>
                    <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-8">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white"><h5 class="mb-0 text-secondary"><i class="fas fa-chart-bar me-2"></i> Stock Levels</h5></div>
                    <div class="card-body">
                        <canvas id="barChart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white"><h5 class="mb-0 text-secondary"><i class="fas fa-chart-pie me-2"></i> Stock Status</h5></div>
                    <div class="card-body">
                        <canvas id="doughnutChart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 border-bottom-0">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-secondary"><i class="fas fa-list me-2"></i> List of Products</h5>
                    <form action="{{ url_for('index') }}" method="GET" class="d-flex" style="width: 300px;">
                        <input type="text" name="q" class="form-control form-control-sm me-2" placeholder="Search..." value="{{ request.args.get('q', '') }}">
                        <button class="btn btn-sm btn-outline-secondary" type="submit">Search</button>
                    </form>
                </div>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Image</th>
                            <th>SKU</th>
                            <th>Category</th> 
                            <th>Product Name</th>
                            <th>Stock</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr class="{% if product.current_quantity < 5 %}table-warning{% endif %}">
                            <td class="ps-4">
                                {% if product.image_url %}
                                    <img src="{{ url_for('static', filename='uploads/' + product.image_url) }}" style="width: 40px; height: 40px; object-fit: cover;" class="rounded border">
                                {% else %}
                                    <div class="bg-secondary rounded" style="width: 40px; height: 40px;"></div>
                                {% endif %}
                            </td>
                            <td><span class="badge bg-light text-dark border">{{ product.sku }}</span></td>
                            <td><span class="badge bg-info text-dark">{{ product.category }}</span></td> 
                            <td class="fw-bold text-dark">{{ product.name }}</td>
                            <td>
                                <div class="d-flex align-items-center justify-content-center">
                                    <h5 class="mb-0 me-3">
                                        <span class="badge {{ 'bg-danger' if product.current_quantity < 5 else 'bg-success' }}">
                                            {{ product.current_quantity }}
                                        </span>
                                    </h5>
                                    <button type="button" class="btn btn-success btn-sm me-1" onclick="openStockModal('{{ product.id }}', '{{ product.name }}', 'IN')"><i class="fas fa-plus"></i></button>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="openStockModal('{{ product.id }}', '{{ product.name }}', 'OUT')"><i class="fas fa-minus"></i></button>
                                </div>
                            </td>
                            <td class="text-center">
                                {% if current_user.role == 'admin' %}
                                    <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-primary btn-sm me-1"><i class="fas fa-edit"></i> Edit</a>
                                    <a href="{{ url_for('delete_product', product_id=product.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('Delete this product?');"><i class="fas fa-trash"></i> Delete</a>
                                {% else %}
                                    <span class="text-muted small"><i class="fas fa-lock"></i> View Only</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="card-footer bg-white py-3">
                <div class="d-flex justify-content-end align-items-center">
                    <small class="text-muted me-3">Showing all products</small>
                    <div>
                        <a href="{{ url_for('export_data') }}" class="btn btn-success btn-sm me-1"><i class="fas fa-file-excel"></i> Export Excel</a>
                        
                        {% if current_user.role == 'admin' %}
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#importModal"><i class="fas fa-file-upload"></i> Import Excel</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white"><h5 class="modal-title">üìÇ Import Stock</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <form action="{{ url_for('import_data') }}" method="POST" enctype="multipart/form-data">
          <div class="modal-body"><input type="file" name="file" class="form-control" accept=".xlsx" required></div>
          <div class="modal-footer"><button type="submit" class="btn btn-primary">Upload</button></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="stockModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="stockForm" method="POST">
          <div class="modal-header text-white" id="modalHeader"><h5 class="modal-title" id="modalTitle">Update Stock</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <h5 id="productNameDisplay" class="mb-3 text-center fw-bold"></h5>
            <input type="hidden" name="type" id="transactionType">
            <div class="mb-3"><label class="form-label">Quantity</label><input type="number" name="quantity" class="form-control" value="1" min="1" required></div>
            <div class="mb-3" id="supplierDiv" style="display:none;">
                <label class="form-label">Supplier</label>
                <select name="party_name" class="form-select" id="supplierSelect">
                    <option value="-">-- Select --</option>
                    {% for s in suppliers %}<option value="{{ s.name }}">{{ s.name }}</option>{% endfor %}
                    <option value="General">General</option>
                </select>
            </div>
            <div class="mb-3" id="customerDiv" style="display:none;">
                <label class="form-label">Customer</label>
                <select name="party_name" class="form-select" id="customerSelect">
                    <option value="-">-- Select --</option>
                    {% for c in customers %}<option value="{{ c.name }}">{{ c.name }}</option>{% endfor %}
                    <option value="General">General</option>
                </select>
            </div>
          </div>
          <div class="modal-footer"><button type="submit" class="btn btn-primary">Confirm</button></div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// 1. Script ‡πÄ‡∏õ‡∏¥‡∏î Modal
function openStockModal(productId, productName, type) {
    document.getElementById('stockForm').action = "/update_stock/" + productId;
    document.getElementById('productNameDisplay').innerText = productName;
    document.getElementById('transactionType').value = type;
    
    var header = document.getElementById('modalHeader');
    var title = document.getElementById('modalTitle');
    var supDiv = document.getElementById('supplierDiv');
    var cusDiv = document.getElementById('customerDiv');
    var supSelect = document.getElementById('supplierSelect');
    var cusSelect = document.getElementById('customerSelect');

    if (type === 'IN') {
        header.className = 'modal-header bg-success text-white';
        title.innerText = 'üì• Receive Stock (IN)';
        supDiv.style.display = 'block'; cusDiv.style.display = 'none';
        supSelect.name = 'party_name'; cusSelect.name = '';           
    } else {
        header.className = 'modal-header bg-danger text-white';
        title.innerText = 'üì§ Issue Stock (OUT)';
        supDiv.style.display = 'none'; cusDiv.style.display = 'block';
        supSelect.name = ''; cusSelect.name = 'party_name'; 
    }
    var myModal = new bootstrap.Modal(document.getElementById('stockModal'));
    myModal.show();
}

// 2. Script ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü (‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Python)
document.addEventListener("DOMContentLoaded", function() {
    var names = {{ product_names | tojson }};
    var quantities = {{ product_quantities | tojson }};
    
    // ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (Bar Chart)
    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: names,
            datasets: [{
                label: 'Stock Quantity',
                data: quantities,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });

    // ‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏î‡∏ô‡∏±‡∏ó (Doughnut Chart)
    new Chart(document.getElementById('doughnutChart'), {
        type: 'doughnut',
        data: {
            labels: ['In Stock', 'Low Stock', 'Out of Stock'],
            datasets: [{
                data: [
                    {{ total_products - low_stock - out_of_stock }}, // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
                    {{ low_stock }}, // ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î
                    {{ out_of_stock }} // ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß
                ],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545']
            }]
        }
    });
});
</script>

</body>
</html>